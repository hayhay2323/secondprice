"use strict";exports.id=234,exports.ids=[234],exports.modules={4667:t=>{t.exports=class{constructor(t={}){this.name=t.name||"unnamed-scraper",this.baseUrl=t.baseUrl||"",this.defaultHeaders={"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8","Accept-Language":"en-US,en;q=0.5",...t.headers},this.timeout=t.timeout||3e4,this.retryCount=t.retryCount||3,this.retryDelay=t.retryDelay||2e3}sleep(t){return new Promise(e=>setTimeout(e,t))}normalizeItem(t){return{id:t.id||`${this.name}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,title:t.title||"",description:t.description||"",price:t.price||null,currency:t.currency||"HKD",condition:t.condition||"unknown",category:t.category||"unknown",source:this.name,url:t.url||"",images:t.images||[],createdAt:t.createdAt||new Date().toISOString(),metadata:t.metadata||{}}}log(t,e="info"){let r=new Date().toISOString();console[e](`[${r}] [${this.name}] [${e.toUpperCase()}] ${t}`)}handleError(t,e){this.log(`Error in ${e}: ${t.message}`,"error"),t.stack&&this.log(`Stack: ${t.stack}`,"debug")}async withRetry(t,e){let r;for(let a=1;a<=this.retryCount;a++)try{return this.log(`Attempt ${a}/${this.retryCount} for task: ${e}`),await t()}catch(t){if(r=t,this.log(`Attempt ${a} failed: ${t.message}`,"warn"),a<this.retryCount){let t=this.retryDelay*a;this.log(`Retrying in ${t}ms...`),await this.sleep(t)}}throw this.handleError(r,`Task ${e} failed after ${this.retryCount} attempts`),r}}},7853:(t,e,r)=>{let a=r(2167),i=r(8048),o=r(4667);t.exports=class extends o{constructor(t={}){super({name:"carousell",baseUrl:"https://hk.carousell.com",...t})}async search(t,e={}){try{let{limit:r=20,sort:o="popular",category:s=""}=e,l=`${this.baseUrl}/search/${encodeURIComponent(t)}`;s&&(l+=`/c/${s}`),l+=`?sort_by=${o}`,this.log(`Searching for "${t}" on Carousell...`);let c=await this.withRetry(async()=>await a.get(l,{headers:this.defaultHeaders,timeout:this.timeout}),`carousell-search-${t}`),n=i.load(c.data),h=[];return n(".product-card").each((t,e)=>{if(t>=r)return!1;let a=n(e),i=a.find(".product-title").text().trim(),o=a.find(".product-price").text().trim(),s=this.parsePrice(o),l=a.find("a.product-link").attr("href"),c=l.startsWith("/")?`${this.baseUrl}${l}`:l,d=a.find(".product-image img").attr("src")||"",u=this.normalizeItem({title:i,price:s,currency:"HKD",url:c,images:d?[d]:[],metadata:{platform:"carousell",originalPrice:o}});h.push(u)}),this.log(`Found ${h.length} products for "${t}"`),h}catch(e){throw this.handleError(e,`search-${t}`),e}}parsePrice(t){if(!t)return null;if(t.includes("-")){let e=t.split("-"),r=this.parsePrice(e[0]);return r}let e=t.replace(/[^0-9,.]/g,"");try{return parseFloat(e.replace(/,/g,""))}catch(t){return null}}async getProductDetails(t){try{this.log(`Fetching product details from ${t}`);let e=await this.withRetry(async()=>await a.get(t,{headers:this.defaultHeaders,timeout:this.timeout}),`carousell-details-${t}`),r=i.load(e.data),o=r(".product-detail-title").text().trim(),s=r(".product-detail-description").text().trim(),l=r(".product-detail-price").text().trim(),c=this.parsePrice(l),n=r(".product-detail-condition").text().trim(),h=r(".product-detail-category").text().trim(),d=[];return r(".product-detail-images img").each((t,e)=>{let a=r(e).attr("src");a&&d.push(a)}),this.normalizeItem({title:o,description:s,price:c,condition:n,category:h,url:t,images:d,metadata:{platform:"carousell",originalPrice:l}})}catch(e){throw this.handleError(e,`getProductDetails-${t}`),e}}}},6675:(t,e,r)=>{let a=r(8018),i=r(4667);t.exports=class extends i{constructor(t={}){super({name:"facebook-marketplace",baseUrl:"https://www.facebook.com/marketplace",...t}),this.browser=null,this.isLoggedIn=!1,this.loginCredentials=t.credentials||null}async initBrowser(){this.browser||(this.log("Initializing browser..."),this.browser=await a.launch({headless:"new",args:["--no-sandbox","--disable-setuid-sandbox","--disable-dev-shm-usage","--disable-accelerated-2d-canvas","--disable-gpu"]}))}async closeBrowser(){this.browser&&(this.log("Closing browser..."),await this.browser.close(),this.browser=null)}async login(){if(this.isLoggedIn)return!0;if(!this.loginCredentials)return this.log("No login credentials provided. Some features may be limited.","warn"),!1;try{await this.initBrowser();let t=await this.browser.newPage();await t.setViewport({width:1280,height:800}),await t.setUserAgent(this.defaultHeaders["User-Agent"]),this.log("Navigating to Facebook login page..."),await t.goto("https://www.facebook.com/login",{waitUntil:"networkidle2",timeout:this.timeout});let e=await t.$('button[data-testid="cookie-policy-manage-dialog-accept-button"]');e&&(await e.click(),await t.waitForNavigation({waitUntil:"networkidle2"})),this.log("Filling login credentials..."),await t.type("#email",this.loginCredentials.email),await t.type("#pass",this.loginCredentials.password),await Promise.all([t.click("#loginbutton"),t.waitForNavigation({waitUntil:"networkidle2"})]);let r=t.url();return this.isLoggedIn=!r.includes("login")&&!r.includes("checkpoint"),this.isLoggedIn?this.log("Successfully logged in to Facebook"):this.log("Failed to login. Check your credentials or there might be a security check.","error"),await t.close(),this.isLoggedIn}catch(t){return this.handleError(t,"login"),!1}}async search(t,e={}){try{let{limit:r=20,location:a="hongkong"}=e;await this.initBrowser(),this.loginCredentials&&!this.isLoggedIn&&await this.login();let i=await this.browser.newPage();await i.setViewport({width:1280,height:800}),await i.setUserAgent(this.defaultHeaders["User-Agent"]);let o=`${this.baseUrl}/search?query=${encodeURIComponent(t)}&exact=false`;this.log(`Searching for "${t}" on Facebook Marketplace...`),await i.goto(o,{waitUntil:"networkidle2",timeout:this.timeout});let s=await i.$('button[data-testid="cookie-policy-manage-dialog-accept-button"]');s&&(await s.click(),await i.waitForTimeout(1e3)),await i.waitForSelector('[aria-label="Marketplace items"]',{timeout:this.timeout}),this.log("Scrolling to load more items..."),await this.autoScroll(i,r),this.log("Extracting product information...");let l=await i.evaluate(t=>{let e=[],r=document.querySelectorAll('[aria-label="Marketplace items"] > div > div');for(let a=0;a<Math.min(r.length,t);a++){let t=r[a],i=t.querySelector('a[href*="/marketplace/item/"]');if(!i)continue;let o=i.href,s=t.querySelector("span.a8c37x1j"),l=s?s.textContent.trim():"",c=t.querySelector("span.d2edcug0"),n=c?c.textContent.trim():"",h=t.querySelector("img"),d=h?h.src:"",u=t.querySelector("span.a8c37x1j + span.a8c37x1j"),g=u?u.textContent.trim():"";o&&l&&e.push({title:l,priceText:n,url:o,image:d,location:g,platform:"facebook"})}return e},r);await i.close();let c=l.map(t=>this.normalizeItem({title:t.title,price:this.parsePrice(t.priceText),url:t.url,images:t.image?[t.image]:[],metadata:{platform:"facebook",originalPrice:t.priceText,location:t.location}}));return this.log(`Found ${c.length} products for "${t}"`),c}catch(e){return this.handleError(e,`search-${t}`),[]}}async getProductDetails(t){try{await this.initBrowser();let e=await this.browser.newPage();await e.setViewport({width:1280,height:800}),await e.setUserAgent(this.defaultHeaders["User-Agent"]),this.log(`Fetching product details from ${t}`),await e.goto(t,{waitUntil:"networkidle2",timeout:this.timeout}),await e.waitForSelector('[data-pagelet="MainFeed"]',{timeout:this.timeout});let r=await e.evaluate(()=>{let t=document.querySelector("h1.a8c37x1j"),e=t?t.textContent.trim():"",r=document.querySelector("span.d2edcug0"),a=r?r.textContent.trim():"",i=document.querySelector('div[data-pagelet="MainFeed"] span.d2edcug0.hpfvmrgz'),o=i?i.textContent.trim():"",s=document.querySelector('[data-pagelet="MainFeed"] a.a8c37x1j[href*="facebook.com/marketplace/"]'),l=s?s.textContent.trim():"",c=[],n=document.querySelectorAll('[data-pagelet="MainFeed"] img');n.forEach(t=>{t.src&&!c.includes(t.src)&&c.push(t.src)});let h=document.querySelector('[data-pagelet="MainFeed"] a.a8c37x1j[href*="/category/"]'),d=h?h.textContent.trim():"";return{title:e,priceText:a,description:o,location:l,images:c,category:d}});return await e.close(),this.normalizeItem({title:r.title,description:r.description,price:this.parsePrice(r.priceText),category:r.category,url:t,images:r.images,metadata:{platform:"facebook",originalPrice:r.priceText,location:r.location}})}catch(e){throw this.handleError(e,`getProductDetails-${t}`),e}}async autoScroll(t,e){await t.evaluate(async t=>{let getItemCount=()=>document.querySelectorAll('[aria-label="Marketplace items"] > div > div').length;await new Promise(e=>{let r=0,a=setInterval(()=>{let i=document.body.scrollHeight;window.scrollBy(0,100),r+=100,(getItemCount()>=t||r>=3*i)&&(clearInterval(a),e())},100)})},e),await t.waitForTimeout(1e3)}parsePrice(t){if(!t)return null;let e=t.replace(/[^0-9,.]/g,"");try{return parseFloat(e.replace(/,/g,""))}catch(t){return null}}}},4234:(t,e,r)=>{let a=r(7853),i=r(6675);t.exports=class{constructor(t={}){this.scrapers={},this.registerScraper("carousell",new a(t.carousell||{})),this.registerScraper("facebook",new i(t.facebook||{})),this.log("ScraperManager initialized")}registerScraper(t,e){this.scrapers[t]=e,this.log(`Registered ${t} scraper`)}getScraper(t){return this.scrapers[t]||null}getAllScrapers(){return this.scrapers}async searchPlatform(t,e,r={}){try{let a=this.getScraper(t);if(!a)throw Error(`Scraper for platform "${t}" not found`);return this.log(`Searching for "${e}" on ${t}...`),await a.search(e,r)}catch(r){return this.handleError(r,`searchPlatform-${t}-${e}`),[]}}async searchAll(t,e={}){try{this.log(`Searching for "${t}" on all platforms...`);let{platforms:r=Object.keys(this.scrapers),limit:a=20}=e,i={},o=r.map(r=>this.searchPlatform(r,t,{...e,limit:a}).then(t=>{i[r]=t,this.log(`Found ${t.length} items on ${r}`)}).catch(t=>{this.handleError(t,`searchAll-${r}`),i[r]=[]}));return await Promise.all(o),i}catch(e){return this.handleError(e,`searchAll-${t}`),{}}}async searchAndMerge(t,e={}){try{let r=await this.searchAll(t,e),a=[];for(let t in r)a=a.concat(r[t]);return"price"===e.sortBy&&a.sort((t,r)=>null===t.price?1:null===r.price?-1:"desc"===e.sortOrder?r.price-t.price:t.price-r.price),e.totalLimit&&a.length>e.totalLimit&&(a=a.slice(0,e.totalLimit)),this.log(`Merged results: ${a.length} items`),a}catch(e){return this.handleError(e,`searchAndMerge-${t}`),[]}}async getProductDetails(t,e){try{let r=this.getScraper(t);if(!r)throw Error(`Scraper for platform "${t}" not found`);return this.log(`Getting product details from ${t}: ${e}`),await r.getProductDetails(e)}catch(r){throw this.handleError(r,`getProductDetails-${t}-${e}`),r}}async close(){try{for(let t in this.log("Closing all scrapers..."),this.scrapers){let e=this.scrapers[t];"function"==typeof e.closeBrowser&&await e.closeBrowser()}this.log("All scrapers closed")}catch(t){this.handleError(t,"close")}}log(t,e="info"){let r=new Date().toISOString();console[e](`[${r}] [ScraperManager] [${e.toUpperCase()}] ${t}`)}handleError(t,e){this.log(`Error in ${e}: ${t.message}`,"error"),t.stack&&this.log(`Stack: ${t.stack}`,"debug")}}}};